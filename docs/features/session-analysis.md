# 세션 분석 기능 (Session Analysis)

## 개요

세션 분석 기능은 Claude CLI 세션 로그에서 사용자가 직접 입력한 질문과 Claude가 내부적으로 생성한 요청을 분리하여 분석할 수 있는 기능입니다. 이를 통해 실제 사용자 의도와 자동화된 워크플로우를 명확하게 구분하여 이해할 수 있습니다.

## 주요 기능

### 1. 사용자 질문 필터링 (User Questions)

세션 로그에서 순수한 사용자 질문만 추출합니다.

**필터링 대상 (제외됨)**:
- Tool result (`[{"tool_use_id"...}`)
- System messages (`Caveat:...`)
- Command messages (`<command-name>`, `<command-message>`)
- Empty stdout (`<local-command-stdout></local-command-stdout>`)

**결과**: 사용자가 직접 입력한 질문만 표시

### 2. 자동 생성 요청 필터링 (Auto-Generated Requests)

Claude가 내부적으로 생성한 요청(sidechain)만 추출합니다.

**필터링 기준**:
- `isSidechain === true` 속성을 가진 이벤트

**결과**: Task 에이전트 등 자동화된 프로세스의 요청만 표시

### 3. 탭 기반 UI

두 가지 뷰를 쉽게 전환할 수 있는 탭 인터페이스를 제공합니다.

## 사용 방법

### 1. 세션 목록에서 접근

```
Claude Projects → 프로젝트 선택 → 세션 목록
```

각 세션 카드에 "📊 View Analysis" 버튼이 표시됩니다.

### 2. 세션 상세 페이지에서 접근

```
세션 상세 페이지 → View Analysis 버튼 클릭
```

세션 로그 뷰어 상단의 "View Analysis" 버튼을 클릭합니다.

### 3. 분석 페이지 사용

**User Questions 탭**:
- 사용자가 직접 입력한 질문만 표시
- 실제 사용자 의도 파악에 유용

**Auto-Generated Requests 탭**:
- Claude가 내부적으로 생성한 요청만 표시
- 자동화된 워크플로우 이해에 유용

**컨트롤**:
- **Back to Full Session**: 전체 세션 로그로 돌아가기
- **Refresh**: 데이터 새로고침
- **Close**: 세션 목록으로 돌아가기

## 기술 구현

### Backend (Services)

**파일**: `src/services/claudeSessions.ts`

```typescript
// 사용자 질문 필터링
export const getUserQuestions = (
  projectPath: string,
  sessionId: string
): ClaudeSessionEntry[]

// 자동 생성 요청 필터링
export const getAutoGeneratedRequests = (
  projectPath: string,
  sessionId: string
): ClaudeSessionEntry[]
```

### IPC Layer

**파일**: `src/ipc/handlers/claudeSessionsHandlers.ts`

**채널**:
- `claude-sessions:get-user-questions`
- `claude-sessions:get-auto-generated-requests`
- `claude-sessions:get-session-analysis`

### Frontend (React)

**페이지**: `src/pages/ClaudeSessionAnalysisPage.tsx`

**라우팅**: `/claude-projects/:projectDirName/sessions/:sessionId/analysis`

**주요 컴포넌트**:
- 탭 기반 뷰 전환
- 실시간 데이터 로딩
- 에러 핸들링

### API 타입

**파일**: `src/types/api/sessions.ts`

```typescript
export interface SessionAnalysisData {
  userQuestions: ClaudeSessionEntry[];
  autoGeneratedRequests: ClaudeSessionEntry[];
}

export interface ClaudeSessionsAPI {
  // ... 기존 API
  getSessionAnalysis: (
    projectPath: string,
    sessionId: string
  ) => Promise<SessionAnalysisData>;

  getUserQuestions: (
    projectPath: string,
    sessionId: string
  ) => Promise<ClaudeSessionEntry[]>;

  getAutoGeneratedRequests: (
    projectPath: string,
    sessionId: string
  ) => Promise<ClaudeSessionEntry[]>;
}
```

## 데이터 흐름

```
1. User clicks "View Analysis"
   ↓
2. Navigate to /claude-projects/:projectDirName/sessions/:sessionId/analysis
   ↓
3. ClaudeSessionAnalysisPage loads
   ↓
4. Parallel API calls:
   - getUserQuestions(projectPath, sessionId)
   - getAutoGeneratedRequests(projectPath, sessionId)
   ↓
5. IPC: claude-sessions:get-user-questions
   IPC: claude-sessions:get-auto-generated-requests
   ↓
6. Backend filters session log entries
   ↓
7. Return filtered data to frontend
   ↓
8. Display in tabbed UI
```

## 활용 사례

### 1. 실제 사용자 의도 파악

**시나리오**: 세션이 길어져서 실제 사용자가 무엇을 요청했는지 파악하기 어려운 경우

**해결**: User Questions 탭에서 순수한 사용자 질문만 확인

### 2. 자동화 워크플로우 분석

**시나리오**: Task 에이전트가 내부적으로 어떤 작업을 수행했는지 확인

**해결**: Auto-Generated Requests 탭에서 자동 생성된 요청 추적

### 3. 디버깅

**시나리오**: 세션에서 예상과 다른 동작이 발생한 경우

**해결**: 사용자 질문과 자동 요청을 분리하여 문제 원인 파악

### 4. 사용 패턴 분석

**시나리오**: 프로젝트에서 자주 묻는 질문 유형 파악

**해결**: 여러 세션의 User Questions를 비교 분석

## 제한사항

1. **정적 분석**: 실시간 스트리밍 중에는 사용 불가 (저장된 세션만 분석)
2. **구조화된 컨텐츠**: 문자열 형태의 메시지만 처리 (배열 등 복잡한 구조는 제외)
3. **메타데이터 의존**: `isSidechain` 필드가 없는 구 버전 세션은 auto-generated 필터링 불가

## 향후 개선 방향

- [ ] 실시간 스트리밍 분석 지원
- [ ] 통계 대시보드 (질문 유형별 분포, 시간대별 패턴 등)
- [ ] 세션 간 비교 분석
- [ ] 키워드 기반 검색 및 필터링
- [ ] Export 기능 (CSV, JSON)
- [ ] 시각화 차트 (타임라인, 히스토그램 등)

## 관련 파일

### 핵심 파일
- `src/services/claudeSessions.ts` - 필터링 로직
- `src/pages/ClaudeSessionAnalysisPage.tsx` - 분석 페이지
- `src/ipc/handlers/claudeSessionsHandlers.ts` - IPC 핸들러
- `src/types/api/sessions.ts` - 타입 정의

### 관련 컴포넌트
- `src/components/sessions/SessionLogViewer.tsx` - 세션 뷰어 (분석 버튼 추가)
- `src/pages/ClaudeSessionsListPage.tsx` - 세션 목록 (분석 버튼 추가)
- `src/pages/ClaudeSessionDetailPage.tsx` - 세션 상세 (분석 페이지 이동)

### 스타일
- `src/pages/ClaudeSessionAnalysisPage.module.css` - 분석 페이지 스타일
- `src/pages/ClaudeSessionsListPage.module.css` - 분석 버튼 스타일

## 테스트

필터링 로직 검증:

```bash
# Test script
node test-final.js
```

**예상 결과**:
- 전체 이벤트: ~200개
- 사용자 질문: 2-3개 (실제 사용자 입력만)
- tool_result, system messages 등은 모두 제외됨

## 문의 및 피드백

기능 개선 사항이나 버그 리포트는 프로젝트 이슈 트래커에 등록해주세요.
